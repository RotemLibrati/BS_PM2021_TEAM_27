pipeline {
    environment {
        OUTPUT1 = "foo"
    }
    agent {
        docker { image 'eilonc285/repos-team27:team27' }
    }
    triggers {
        githubPush()
    }
    stages {
        stage('Build') {
            steps {
                sh """
                    cd BS_PM2021_TEAM_27
                    python manage.py makemigrations
                    python manage.py migrate
                """
            }
        }
        stage('Run Unit Tests') {
            steps {
                dir("BS_PM2021_TEAM_27"){
                    script{
                        try{
                            OUTPUT1 = sh(returnStdout: true, script: "python manage.py test Preschool_Play.tests.TestInboxView")
                        }finally{
                            echo OUTPUT1 > out1.txt
                            echo '0000000000000000000000000000'
                            cat out1.txt
                        }
                    }
                }
                /*script{
                    try{
                        sh """
                        cd BS_PM2021_TEAM_27
                        python manage.py test 2>&1 stdout.txt
                        echo '000000000000000000000000000'
                        cat stdout.txt
                        echo '000000000000000000000000000'
                        cat stderr.txt
                        echo '000000000000000000000000000'
                        """
                    }
                    catch(e){
                        sh """
                            echo ${e}
                            echo '++++++++++++++++++++++++++++++++++'
                            cat stdout.txt
                            echo '++++++++++++++++++++++++++++++++++'
                            cat stderr.txt
                            echo '++++++++++++++++++++++++++++++++++'
                        """
                    }
                }*/
            }
        }
    }
    post{
        always{
            echo '99999999999999999999999999'
            echo OUTPUT1
            sh "cat out1.txt"
        }
    }
}